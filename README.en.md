ðŸŒ [ç®€ä½“ä¸­æ–‡](README.cn.md) | English

* # **ShiTu C API User Manual**

  **Version:** 1.0
  **Last Updated:** 2025-06-21

  ## **1. Introduction**

  The ShiTu C API provides a set of powerful and highly optimized C language interfaces, encapsulating underlying functionalities such as image recognition, feature extraction, object detection, and vector indexing. This API is deeply refactored based on Baidu's **PaddleClas** vision suite, aiming to provide developers with a stable, easy-to-use, and high-performance AI vision solution.

  By hiding complex internal dependencies (such as **Paddle Inference v3.0.0-beta1**, **OpenCV 4.11.0**, **FAISS 1.7.4**), ShiTuApi offers developers a consistent and reliable interface, supporting rapid integration in various languages such as C/C++, C#, and Python.

  **Core Features:**
  *(Verified against the ShiTuApiTestApp code)*

  *   **License Management**: Supports a trial mode and can be activated via a license key, ensuring protection for commercial applications.
  *   **Model Loading and Initialization**: Flexibly loads and configures detection and recognition models, along with all related parameters, through a single `config.yaml` file.
  *   **Index Building**: Supports batch building of high-dimensional feature vector indexes from an image list file (`image_list.txt`).
  *   **Image Retrieval**:
      *   Supports efficient similar image/object retrieval via **image file path**.
      *   Supports retrieval via **in-memory image data**, suitable for scenarios like video streams and camera feeds.
      *   Supports **batch folder search** and automatically generates result reports.
  *   **Index Management**: Supports **saving**, **deleting a single or batch** of entries to/from the index.
  *   **Information Query**: Retrieves the index dimension, total number of vectors in real-time, and can query the corresponding label by ID.
  *   **Data Export**: Supports exporting the entire index's ID-to-label mapping relationship to a CSV file for data analysis and migration.

  ## **2. Environment Requirements and Dependencies**

  ### **2.1 Runtime Environment (Windows)**

  The current version of this API focuses on the Windows (x64) platform, aiming to provide a "green", lightweight deployment experience.

  *   **Operating System**: 64-bit Windows 10 or higher.
  *   **C++ Runtime Library**: **Microsoft Visual C++ Redistributable for Visual Studio 2022**. This is a necessary system component for running DLLs generated by the MSVC compiler. Typically, end-users' systems will have this component installed; if not, your application's installer should include it.

  > **Cross-Platform Support**: We have the capability to provide customized versions that run on **Linux**, **Embedded Linux**, or other operating systems based on your business needs. Please contact us for more information.

  ### **2.2 Development Environment Dependencies (Internal Reference)**

  The compilation and building of this API depend on the following core libraries:

  *   **C++ Compiler**: Microsoft Visual C++ (MSVC) v143 or later (Visual Studio 2022).
  *   **Core Libraries**:
      *   Inference Engine: **Paddle Inference v3.0.0-beta1**
      *   Image Processing: **OpenCV 4.11.0**
      *   Vector Retrieval: **FAISS 1.7.4**
      *   Configuration Parsing: **yaml-cpp**

  ## **3. Interface Files**

  To integrate the ShiTu C API into your project, you will need the following files:

  *   **`shitu_c_api.h`**: **Required**. The C API header file, which contains all function declarations, structure definitions, and enumerations.
  *   **`shitu_c_api.dll`**: **Required**. The compiled 64-bit dynamic-link library file, which your application needs to load at runtime.
  *   **`shitu_c_api.lib`**: **Required (for C++)**. When you compile C/C++ code with MSVC, you need to link this import library.

  ## **4. API Usage Flow**

  A typical API usage flow is as follows, and the `ShiTuApiTestApp` sample program fully demonstrates this process:

  1.  **Create Handle**: Call `ShiTuApi_Create()` to get an API instance handle (`ShiTuApiHandle`). This is the first step for all operations.
  2.  **Initialize API**: Call `ShiTuApi_InitializeWithLicense()` and pass the path to the `config.yaml` file. This is the **only recommended way to initialize**. This function automatically handles license status checking and the initialization of all modules.
  3.  **Check Initialization Status**: Call `ShiTuApi_IsInitialized()` to confirm if the API is ready.
  4.  **Perform Operations**: Call the corresponding API functions based on business requirements:
      *   `ShiTuApi_BuildIndexFromFile()`: Build or append to the index from `image_list.txt`.
      *   `ShiTuApi_SearchByPath()`: Perform recognition on a single image.
      *   `ShiTuApi_DeleteItem()` / `ShiTuApi_DeleteItems()`: Remove entries from the index.
      *   `ShiTuApi_GetLabelById()`: Query a label by its ID.
      *   `ShiTuApi_SaveIndex()`: Persist in-memory index changes to disk.
  5.  **Handle Results and Memory**:
      *   **The caller must be responsible for freeing memory allocated by the API** to avoid memory leaks.
      *   Use `ShiTuApi_FreeResults()` to free the result array returned by `ShiTuApi_Search*` functions.
      *   Use `ShiTuApi_FreeString()` to free the string returned by the `ShiTuApi_GetLabelById` function.
      *   Use `ShiTuApi_FreeLicenseInfoContents()` to free the strings within the license information structure.
  6.  **Error Handling**: After each API function call, check the returned `ShiTuApiResultCode`. If it is not `SHITU_API_SUCCESS`, you should call `ShiTuApi_GetLastErrorMsg()` to get a detailed error message string for debugging.
  7.  **Destroy Handle**: When the application exits or the API instance is no longer needed, you **must** call `ShiTuApi_Destroy()` to release all related resources.

  ## **5. Core Data Structures**

  *   **`ShiTuApiHandle`**: An opaque pointer representing an API instance.
  *   **`CShiTuLicenseInfo`**: A structure containing license status, machine code, expiration date, and other information.
  *   **`CShiTuSearchResult`**: A structure containing information for a single search result:
      *   `id` (`int64_t`): The matched index ID.
      *   `label` (`char*`): The matched label string (UTF-8).
      *   `score` (`float`): The recognition/matching score (0.0 ~ 1.0).
      *   `distance` (`float`): The feature vector distance (L2 or IP).
      *   `box` (`CShiTuBoundingBox`): The coordinates of the detected bounding box.

  ## **6. Function Details**

  (The following function list has been verified against the existing code. For detailed parameter descriptions, please refer to the `shitu_c_api.h` file)

  *   **Handle Management**: `ShiTuApi_Create`, `ShiTuApi_Destroy`, `ShiTuApi_IsInitialized`
  *   **Initialization**: `ShiTuApi_InitializeWithLicense`
  *   **License**: `ShiTuApi_ActivateLicenseKey`, `ShiTuApi_GetLicenseInfo`, `ShiTuApi_FreeLicenseInfoContents`
  *   **Index Operations**: `ShiTuApi_BuildIndexFromFile`, `ShiTuApi_SaveIndex`, `ShiTuApi_DeleteItem`, `ShiTuApi_DeleteItems`
  *   **Retrieval Operations**: `ShiTuApi_SearchByPath`, `ShiTuApi_SearchByData`
  *   **Information Query**: `ShiTuApi_GetIndexDimension`, `ShiTuApi_GetIndexNumItems`, `ShiTuApi_GetLabelById`
  *   **Data Export**: `ShiTuApi_ExportLabels`, `ShiTuApi_GetAllIdsAndLabels`, `ShiTuApi_FreeAllIdsAndLabels`
  *   **Memory Management**: `ShiTuApi_FreeResults`, `ShiTuApi_FreeString`
  *   **Error Retrieval**: `ShiTuApi_GetLastErrorMsg`

  ## **7. Configuration File (`config.yaml`) Explanation**

  The API's behavior is primarily controlled by the `config.yaml` file. **All path configurations support both relative paths (relative to the DLL's runtime directory) and absolute paths**.

  *   **`Global` section:**
      *   `enable_mkldnn`: In CPU mode, set to `true` to enable Intel MKL-DNN acceleration.
      *   `det_inference_model_dir`: Path to the **detection model**. Set this path to enable the "detect then recognize" mode.
      *   `rec_inference_model_dir`: Path to the **recognition model** (**Required**).
      *   `feature_dim`: Feature dimension (**Required**), must match the recognition model.
      *   `threshold`: **Detection confidence threshold**. Filters out detection boxes with low confidence.
      *   `visualize_...` & `freetype_font_path`: Controls whether to generate result images with annotations and the font required to display Chinese characters.

  *   **`IndexProcess` section:**
      *   `index_dir`: Base path for the index files (**Required**).
      *   `index_method`: FAISS index building method. `"IDMap,Flat"` is the most general method for exact search that supports deletion.
      *   `metric_type`: Distance metric ("L2" or "IP").
      *   `threshold`: **Recognition score threshold**. This is the "acceptance line" for recognition results; only matches with a similarity score higher than this value will be returned.
      *   `use_detBuild`: **Index building mode**. `false` for building the index from the whole image, `true` for building after detection.

  ## **8. Error Handling**

  *   **Return Value**: All core API functions return a `ShiTuApiResultCode`. Be sure to check if the return value is `SHITU_API_SUCCESS`.
  *   **Error Message**: If a function call fails, immediately call `ShiTuApi_GetLastErrorMsg()` to get a detailed, human-readable error description string.
  *   **Logs**: During runtime, the API may generate a `shitu_api_log.txt` file in the program's directory, which contains more detailed internal debugging information to help diagnose complex problems.

  ## **9. Thread Safety**

  *   **Handle Instance**: **The same `ShiTuApiHandle` instance is thread-safe**. You can create a global handle and then call functions like `ShiTuApi_SearchByPath` simultaneously from multiple worker threads. The internal mutex locks in the API will ensure the atomicity of operations and data integrity.
  *   **Callback Function**: The progress callback function for `ShiTuApi_BuildIndexFromFile` is called from an internal worker thread. **It is strictly forbidden to perform any time-consuming operations or directly update UI controls within the callback**. To update the UI, you must use the cross-thread invocation mechanism provided by your UI framework (e.g., `Invoke`/`BeginInvoke` in C#).

  ## **10. Sample Code (`ShiTuApiTestApp` - C#)**

  We provide a fully-featured C# WinForms test application, which is the best starting point for learning and using this API.

  Link for the sample program, models, and dynamic library files: https://pan.baidu.com/s/1JAtsiL5Zh6RSxRrxcp9qAw?pwd=5574 Access Code: 5574

  **Core Invocation Logic (Simplified):**

  ```csharp
  // Namespace reference
  using static ShiTuApiTestApp.ShiTuCApi;
  
  // ...
  
  IntPtr apiHandle = IntPtr.Zero;
  
  try 
  {
      // 1. Create handle
      if (ShiTuApi_Create(out apiHandle) != ShiTuApiResultCode.SHITU_API_SUCCESS) 
          throw new Exception("Failed to create handle");
  
      // 2. Initialize API (includes license check)
      if (ShiTuApi_InitializeWithLicense(apiHandle, "config.yaml") != ShiTuApiResultCode.SHITU_API_SUCCESS)
          throw new Exception($"Initialization failed: {ShiTuApi_GetLastErrorMsg()}");
  
      // 3. Perform search
      IntPtr resultsPtr = IntPtr.Zero;
      int numResults = 0;
      var searchResult = ShiTuApi_SearchByPath(apiHandle, "path/to/your/image.jpg", -1f, -1f, -1, out resultsPtr, out numResults);
      
      if (searchResult == ShiTuApiResultCode.SHITU_API_SUCCESS && numResults > 0)
      {
          Console.WriteLine($"Successfully found {numResults} results.");
          // ... Parse resultsPtr here ...
      }
      else 
      {
          Console.WriteLine($"Search failed: {ShiTuApi_GetLastErrorMsg()}");
      }
  }
  catch (Exception ex)
  {
      Console.WriteLine($"An error occurred: {ex.Message}");
  }
  finally
  {
      // 4. Clean up resources
      // if (resultsPtr != IntPtr.Zero) ShiTuApi_FreeResults(resultsPtr, numResults); // Free search results
      if (apiHandle != IntPtr.Zero) ShiTuApi_Destroy(ref apiHandle); // Destroy handle
  }
  ```

  > **Full Project**: Please refer to the `ShiTuApiTestApp` solution, which contains call examples for all functions, UI interaction, background tasks, and best practices for cross-language memory management.

  ## **11. Important Notes**

  *   **Memory Management**: **This is of paramount importance when using the C API**. Any pointer returned by the API and taken over by you (such as search results, label strings) must be freed by calling the corresponding `ShiTuApi_Free*` function after use, otherwise it will lead to serious memory leaks.
  *   **Configuration File**: The API's behavior is highly dependent on `config.yaml`. When initialization fails, please first carefully check if the file path is correct, if there are any YAML syntax errors, and if all parameters perfectly match your models and data.
  *   **UTF-8 Encoding**: All string interactions with the API (paths, labels) use UTF-8 encoding by default. Please ensure your client code can correctly handle UTF-8 strings to avoid garbled text issues.
  *   **Build Version**: Please ensure that your application and `shitu_c_api.dll` are both compiled with the same platform architecture (**x64**) and configuration (**Release**) to avoid compatibility issues.

  Email: cfliyi@outlook.com

  [![Hits](https://hits.sh/github.com/cfliyi/SHITU_C_API.svg)](https://hits.sh/github.com/cfliyi/SHITU_C_API/)
